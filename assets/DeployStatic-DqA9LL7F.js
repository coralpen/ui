import{W as O}from"./UtilityNavbar-BstfAzFS.js";import E from"./TemplateDefault-DFeK-qxG.js";import{S as H}from"./SectionHero-BYjRfA3g.js";import{u as L,a as N,T as W}from"./unzipit.module-B0v4mMoa.js";import{_ as Z,c as K,w as b,r as y,o as l,a as $,b as o,f as r,k as h,t as u,d,e as c,v as f,F as m,g,h as w,j as M}from"./index-COJNagva.js";const G={components:{WrapperPage:O,TemplateDefault:E,SectionHero:H},props:["renderer"],inject:["io"],data:()=>({files:[],hostname:"",repository:"",branch:"",branches:[],webhook:!1,searchRepos:!1,oauthProviders:[],consentUrl:"",search:"",user:null,query:"",organisations:[],repositories:null,loading:"",log:null}),watch:{async searchRepos(t){t&&(await this.getOAuthProviders(),await this.getUser(),await this.getOrganisations(),!this.query&&this.orgs.length&&(this.query=this.orgs[0].query,await this.getRepositories()))},async query(){await this.getRepositories()},async repository(t){var i;const e=(i=this.repositories)==null?void 0:i.items.find(n=>n.clone_url===t);e&&(this.branch=e.default_branch,await this.getBranches(e))}},computed:{id(){return this.$route.params.id||this.hostname},oauthProvidersFiltered(){const t=["github"];return this.oauthProviders.filter(e=>t.includes(e.provider))},orgs(){var t,e;return[{title:(t=this.user)==null?void 0:t.login,query:`user:${(e=this.user)==null?void 0:e.login}`},...this.organisations.map(i=>{var n,p;return{title:(n=i==null?void 0:i.organization)==null?void 0:n.login,query:`org:${(p=i==null?void 0:i.organization)==null?void 0:p.login}`}})]}},async created(){await this.getOAuthProviders(),this.id?await this.getItem():this.branch="main"},methods:{async getUser(){this.loading="user";const t=this.oauthProvidersFiltered.find(e=>e.provider==="github");if(t){let e=await fetch("https://api.github.com/user",{headers:{Accept:"application/vnd.github+json",Authorization:`Bearer ${t.token}`}});this.user=await e.json(),console.log("user",this.user)}this.loading=""},async getOrganisations(){this.loading="organisations";const t=this.oauthProvidersFiltered.find(e=>e.provider==="github");if(t){let e=await fetch("https://api.github.com/user/memberships/orgs?per_page=150",{headers:{Accept:"application/vnd.github+json",Authorization:`Bearer ${t.token}`}});this.organisations=await e.json(),console.log("orgs",this.organisations)}this.loading=""},async getRepositories(){this.loading="repositories";const t=this.oauthProvidersFiltered.find(e=>e.provider==="github");if(t){let e="q="+encodeURIComponent(this.search+(" "+this.query||" user:"+this.user.login)),i=await fetch(`https://api.github.com/search/repositories?${e}&per_page=150`,{headers:{Accept:"application/vnd.github+json",Authorization:`Bearer ${t.token}`}});this.repositories=await i.json(),console.log("repos",this.repositories)}this.loading=""},async getBranches(t){this.loading="branches";const e=this.oauthProvidersFiltered.find(i=>i.provider==="github");if(e){let i=await fetch(t.branches_url.replace("{/branch}","")+"?per_page=150",{headers:{Accept:"application/vnd.github+json",Authorization:`Bearer ${e.token}`}});this.branches=await i.json(),console.log("branches",this.branches)}this.loading=""},consent(t){t&&window.open(t,"_blank")},async getOAuthProviders(){this.loading="providers";const t=await this.io.service("oauth_providers").find({query:{}});this.oauthProviders=t==null?void 0:t.data,this.loading=""},async getItem(){this.loading="app";const t=await this.io.service("static").get(this.id);this.hostname=t.id,this.repository=t.repository,this.branch=t.branch,this.webhook=t.webhook,this.log=t.log,console.log("res",t),this.loading=""},async remove(){this.loading="remove app";const t=await this.io.service("static").remove(this.id);console.log("res",t),this.$router.push("/apps-static"),alert("Static site removed!"),this.loading=""},async attach(){this.loading="attach webhook";const t=await this.io.service("static").patch(this.id,{attach:!0});console.log("res",t),await this.getItem(),alert("Attached to webhook!"),this.loading=""},async detach(){this.loading="detach webhook";const t=await this.io.service("static").patch(this.id,{detach:!0});console.log("res",t),await this.getItem(),alert("Detached from webhook!"),this.loading=""},async update(){var t;this.loading="update app";try{console.log("files",this.files);const e=await this.io.service("static").update(this.id,{buffer:(t=this.files)!=null&&t.length?await this.packTar():null,repository:this.repository,branch:this.branch});console.log("res",e),await this.getItem(),alert("Updated!")}catch(e){console.log("error",e),alert("Could not update: "+e.message)}this.loading=""},async deploy(){var t;this.loading="deploy app";try{console.log("files",this.files);const e=await this.io.service("static").create({hostname:this.id,buffer:(t=this.files)!=null&&t.length?await this.packTar():null,repository:this.repository,branch:this.branch});console.log("res",e),await this.getItem(),alert("Static site is live!")}catch(e){console.log("error",e),alert("Could not deploy: "+e.message)}this.loading=""},async packTar(){let t=new W;for await(let e of this.files)t.append(e.name,new Uint8Array(e.buffer));return t.out},async uploadZip(){return this.files=[],new Promise(t=>{let e=document.createElement("input");e.type="file",e.multiple=!1,e.accept=".zip",e.onchange=async()=>{let i=Array.from(e.files)[0];const{entries:n}=await N(await i.arrayBuffer());for await(const[p,a]of Object.entries(n))n[p].isDirectory||this.files.push({buffer:await a.arrayBuffer(),name:p});t()},e.click()})},async uploadTar(){return this.files=[],new Promise(t=>{let e=document.createElement("input");e.type="file",e.multiple=!1,e.accept=".tar",e.onchange=async()=>{let i=Array.from(e.files)[0],n=await L(await i.arrayBuffer());for await(let p of n)this.files.push({buffer:p.buffer,name:p.name});t()},e.click()})},async uploadFolder(){return this.files=[],new Promise(t=>{let e=document.createElement("input");e.type="file",e.multiple=!0,e.webkitdirectory=!0,e.dir=!0,e.onchange=async()=>{let i=Array.from(e.files);for await(let n of i)this.files.push({buffer:await n.arrayBuffer(),name:n.webkitRelativePath});t()},e.click()})},async uploadFiles(){return this.files=[],new Promise(t=>{let e=document.createElement("input");e.type="file",e.multiple=!0,e.onchange=async()=>{let i=Array.from(e.files);for await(let n of i){let p=await n.arrayBuffer();this.files.push({buffer:p,name:"root/"+n.name})}t()},e.click()})}}},J={class:"w-full"},Q={class:"font-thin text-xl lg:text-3xl xl:pl-6 w-full text-center uppercase"},X={key:0,class:"font-thin block xl:pl-6 w-full text-center uppercase"},Y={class:"mt-8 mb-20 relative overflow-auto w-full"},x={key:0,class:"p-4 overflow-auto shadow-sm my-8 bg-slate-100 text-slate-700"},_={class:"block my-2"},ee={class:"p-4 overflow-auto shadow-sm my-8 bg-slate-100 text-slate-700"},te={class:"p-4 overflow-auto shadow-sm my-8 bg-slate-100 text-slate-700"},se={class:"p-4 overflow-auto shadow-sm my-8 bg-slate-100 text-slate-700"},oe={class:"block my-2"},ie={class:"p-4 overflow-auto shadow-sm my-8 bg-slate-100 text-slate-700"},ae={class:"mr-4 inline-block"},le=["onClick"],re={key:0},ne={class:"block my-2"},ue=["value"],de={class:"block my-2"},pe=["value"],he={class:"block my-2"},ce=["value"],fe={class:"text-right"},me=["disabled"];function ge(t,e,i,n,p,a){const V=y("SectionHero"),j=y("WrapperPage"),z=y("TemplateDefault");return l(),K(z,{renderer:i.renderer},{default:b(()=>[$(V,null,{default:b(()=>[o("div",J,[o("h1",Q,u(a.id?a.id:"Deploy Static App"),1),t.loading?(l(),r("h2",X," Loading - "+u(t.loading)+" ... ",1)):h("",!0)])]),_:1}),$(j,{class:"p-6"},{default:b(()=>{var v,k,C,P,U,A,B,R,S,F,q,D,T;return[o("div",Y,[o("div",null,[o("button",{class:"py-4 p-2 w-full rounded bg-slate-200",onClick:e[0]||(e[0]=s=>a.getItem())}," Reload ")]),t.log?(l(),r("div",x,[o("label",_," Last updated "+u(new Date(((P=(C=(k=(v=t.log)==null?void 0:v[0])==null?void 0:k.commit)==null?void 0:C.author)==null?void 0:P.timestamp)*1e3).toLocaleString())+" by "+u((R=(B=(A=(U=t.log)==null?void 0:U[0])==null?void 0:A.commit)==null?void 0:B.author)==null?void 0:R.name),1)])):h("",!0),o("div",ee,[e[22]||(e[22]=o("label",{class:"block my-2"}," Basic app settings ",-1)),e[23]||(e[23]=d()),t.$route.params.id?h("",!0):c((l(),r("input",{key:0,"onUpdate:modelValue":e[1]||(e[1]=s=>t.hostname=s),placeholder:"Hostname",class:"px-4 py-2 block w-full mb-4"},null,512)),[[f,t.hostname]]),e[24]||(e[24]=d()),t.$route.params.id?c((l(),r("input",{key:1,"onUpdate:modelValue":e[2]||(e[2]=s=>a.id=s),placeholder:"Hostname",readonly:"",class:"px-4 py-2 block w-full mb-4"},null,512)),[[f,a.id]]):h("",!0)]),o("div",te,[e[25]||(e[25]=o("label",{class:"block my-2"}," Upload using drop of Tar / Zip / Folder / Docker Compose File / Docker File ",-1)),o("button",{class:"rounded p-2 bg-slate-200 block w-full mt-2",onClick:e[3]||(e[3]=s=>a.uploadFiles())}," Upload files "),o("button",{class:"rounded p-2 bg-slate-200 block w-full mt-2",onClick:e[4]||(e[4]=s=>t.uploadFolde())}," Upload folder "),o("button",{class:"rounded p-2 bg-slate-200 block w-full mt-2",onClick:e[5]||(e[5]=s=>a.uploadTar())}," Upload tar "),o("button",{class:"rounded p-2 bg-slate-200 block w-full mt-2",onClick:e[6]||(e[6]=s=>a.uploadZip())}," Upload zip "),o("button",{class:"rounded p-2 bg-slate-200 block w-full mt-2",onClick:e[7]||(e[7]=s=>t.files=[])}," Clear files ")]),o("div",se,[o("label",oe," Files count: "+u(t.files.length),1)]),o("div",ie,[e[34]||(e[34]=o("label",{class:"block my-2"}," Clone using a git provider ",-1)),(l(!0),r(m,null,g(a.oauthProvidersFiltered,s=>(l(),r("div",ae,[o("button",{class:"rounded p-2 bg-slate-200 mr-1",onClick:I=>a.consent(s.consent_url)}," Connect to "+u(s.provider),9,le),e[26]||(e[26]=d()),o("button",{class:"rounded p-2 bg-slate-200",onClick:e[8]||(e[8]=I=>t.searchRepos=!t.searchRepos)},u(t.searchRepos?"Close":"Select repository"),1)]))),256)),t.searchRepos?(l(),r("div",re,[o("label",ne," Select user / organisation ("+u(((S=a.orgs)==null?void 0:S.length)||"0")+") ",1),e[27]||(e[27]=d()),c(o("select",{"onUpdate:modelValue":e[9]||(e[9]=s=>t.query=s),class:"mt-2 px-4 py-2 w-full"},[(l(!0),r(m,null,g(a.orgs,s=>(l(),r("option",{value:s.query},u(s.title),9,ue))),256))],512),[[w,t.query]]),e[28]||(e[28]=d()),c(o("input",{"onUpdate:modelValue":e[10]||(e[10]=s=>t.search=s),placeholder:"Search for repository ...",class:"mt-2 px-4 py-2 w-full",onKeypress:e[11]||(e[11]=M(s=>a.getRepositories(),["enter"]))},null,544),[[f,t.search]]),e[29]||(e[29]=d()),o("button",{class:"rounded p-2 mt-2 w-full bg-slate-200",onClick:e[12]||(e[12]=s=>a.getRepositories())}," Search "),e[30]||(e[30]=d()),o("label",de," Select Repository ("+u(((q=(F=t.repositories)==null?void 0:F.items)==null?void 0:q.length)||"0")+") ",1),e[31]||(e[31]=d()),c(o("select",{"onUpdate:modelValue":e[13]||(e[13]=s=>t.repository=s),class:"mt-2 px-4 py-2 w-full"},[(l(!0),r(m,null,g((D=t.repositories)==null?void 0:D.items,s=>(l(),r("option",{value:s.clone_url},u(s.full_name),9,pe))),256))],512),[[w,t.repository]]),e[32]||(e[32]=d()),o("label",he," Select Branch ("+u(((T=t.branches)==null?void 0:T.length)||"0")+") ",1),e[33]||(e[33]=d()),c(o("select",{"onUpdate:modelValue":e[14]||(e[14]=s=>t.branch=s),class:"mt-2 px-4 py-2 w-full"},[(l(!0),r(m,null,g(t.branches,s=>(l(),r("option",{value:s.name},u(s.name),9,ce))),256))],512),[[w,t.branch]])])):h("",!0),e[35]||(e[35]=d()),c(o("input",{"onUpdate:modelValue":e[15]||(e[15]=s=>t.repository=s),placeholder:"Repository url",class:"mt-2 px-4 py-2 w-full"},null,512),[[f,t.repository]]),e[36]||(e[36]=d()),c(o("input",{"onUpdate:modelValue":e[16]||(e[16]=s=>t.branch=s),placeholder:"Branch name",class:"mt-2 px-4 py-2 w-full"},null,512),[[f,t.branch]])]),o("div",fe,[t.$route.params.id?h("",!0):(l(),r("button",{key:0,class:"py-4 p-2 mt-4 w-full rounded bg-slate-200",disabled:!t.hostname,onClick:e[17]||(e[17]=s=>a.deploy())}," Launch ",8,me)),t.$route.params.id?(l(),r("button",{key:1,class:"py-4 p-2 mt-4 w-full rounded bg-slate-200",onClick:e[18]||(e[18]=s=>a.update())}," Update ")):h("",!0),!t.webhook&&t.repository?(l(),r("button",{key:2,class:"py-4 p-2 mt-4 w-full rounded bg-slate-200",onClick:e[19]||(e[19]=s=>a.attach())}," Attach webhook ")):h("",!0),t.webhook&&t.repository?(l(),r("button",{key:3,class:"py-4 p-2 mt-4 w-full rounded bg-slate-200",onClick:e[20]||(e[20]=s=>a.detach())}," Detach webhook ")):h("",!0),t.$route.params.id?(l(),r("button",{key:4,class:"py-4 p-2 mt-4 w-full rounded bg-slate-200",onClick:e[21]||(e[21]=s=>a.remove())}," Remove ")):h("",!0)])])]}),_:1})]),_:1},8,["renderer"])}const Ce=Z(G,[["render",ge],["__scopeId","data-v-dd6576b7"]]);export{Ce as default};
